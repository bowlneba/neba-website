@using System.Net
@implements IAsyncDisposable

@inject IJSRuntime JSRuntime
@inject AzureMapsSettings MapsSettings
@inject ILogger<NebaMap> Logger

<div id="@ContainerId" class="@CssClass" style="@($"height: {Height}; width: {Width}; padding: 0;")">
    <!-- Azure Maps will be rendered here by JavaScript -->
</div>

@code {
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<NebaMap>? _dotNetHelper;
    private string ContainerId { get; set; } = $"neba-map-{Guid.NewGuid():N}";

    [Parameter]
    public IEnumerable<NebaMapLocation> Locations { get; set; } = Array.Empty<NebaMapLocation>();

    [Parameter]
    public bool EnableClustering { get; set; } = true;

    /// <summary>
    /// The center point of the map as [longitude, latitude].
    /// Defaults to Boston, MA (center of New England).
    /// </summary>
    [Parameter]
    public double[] Center { get; set; } = new[] { -71.0589, 42.3601 };

    /// <summary>
    /// The initial zoom level of the map (1-20).
    /// </summary>
    [Parameter]
    public int Zoom { get; set; } = 7;

    [Parameter]
    public string Height { get; set; } = "600px";

    [Parameter]
    public string Width { get; set; } = "100%";

    [Parameter]
    public string CssClass { get; set; } = string.Empty;

    /// <summary>
    /// The map style to display: "road" (default), "satellite", "satellite_road_labels" (hybrid).
    /// </summary>
    [Parameter]
    public string MapStyle { get; set; } = "road";

    /// <summary>
    /// Event callback fired when a location marker is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnLocationSelected { get; set; }

    /// <summary>
    /// Event callback fired when the map is ready and fully initialized.
    /// </summary>
    [Parameter]
    public EventCallback OnMapReady { get; set; }

    /// <summary>
    /// Event callback fired when the map viewport changes (zoom, pan).
    /// </summary>
    [Parameter]
    public EventCallback<MapBounds> OnBoundsChanged { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import",
                "./Maps/NebaMap.razor.js"
            );

            _dotNetHelper = DotNetObjectReference.Create(this);
            await InitializeMapAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_jsModule is not null)
        {
            await UpdateMarkersAsync();
        }
    }

    private async Task InitializeMapAsync()
    {
        if (_jsModule is null)
        {
            return;
        }

        var authConfig = new
        {
            accountId = MapsSettings.AccountId,
            subscriptionKey = MapsSettings.SubscriptionKey
        };

        var mapConfig = new
        {
            containerId = ContainerId,
            center = Center,
            zoom = Zoom,
            enableClustering = EnableClustering,
            style = MapStyle
        };

        var locationData = Locations.Select(loc => new
        {
            id = loc.Id,
            title = WebUtility.HtmlEncode(loc.Title ?? string.Empty),
            description = WebUtility.HtmlEncode(loc.Description ?? string.Empty),
            latitude = loc.Latitude,
            longitude = loc.Longitude,
            metadata = loc.Metadata ?? new Dictionary<string, object>()
        }).ToList();

        await _jsModule.InvokeVoidAsync("initializeMap", authConfig, mapConfig, locationData, _dotNetHelper);
        // OnMapReady is invoked by NotifyMapReady, called from JS inside the 'ready' event
    }

    private async Task UpdateMarkersAsync()
    {
        if (_jsModule is null)
        {
            return;
        }

        var locationData = Locations.Select(loc => new
        {
            id = loc.Id,
            title = WebUtility.HtmlEncode(loc.Title ?? string.Empty),
            description = WebUtility.HtmlEncode(loc.Description ?? string.Empty),
            latitude = loc.Latitude,
            longitude = loc.Longitude,
            metadata = loc.Metadata ?? new Dictionary<string, object>()
        }).ToList();

        await _jsModule.InvokeVoidAsync("updateMarkers", locationData);
    }

    public async Task FocusOnLocationAsync(string locationId)
    {
        if (_jsModule is not null)
        {
            await _jsModule.InvokeVoidAsync("focusOnLocation", locationId);
        }
    }

    public async Task FitBoundsAsync()
    {
        if (_jsModule is not null)
        {
            await _jsModule.InvokeVoidAsync("fitBounds");
        }
    }

    public async Task ClosePopupAsync()
    {
        if (_jsModule is not null)
        {
            await _jsModule.InvokeVoidAsync("closePopup");
        }
    }

    public async Task EnterDirectionsPreviewAsync(string locationId)
    {
        if (_jsModule is not null)
        {
            await _jsModule.InvokeVoidAsync("enterDirectionsPreview", locationId);
        }
    }

    public async Task<RouteData?> ShowRouteAsync(double[] origin, double[] destination)
    {
        if (_jsModule is null)
        {
            return null;
        }

        try
        {
            return await _jsModule.InvokeAsync<RouteData>("showRoute", origin, destination);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[NebaMap] Error showing route");
            return null;
        }
    }

    public async Task ExitDirectionsModeAsync()
    {
        if (_jsModule is not null)
        {
            await _jsModule.InvokeVoidAsync("exitDirectionsMode");
        }
    }

    public async Task SetMapStyleAsync(string style)
    {
        if (_jsModule is not null)
        {
            await _jsModule.InvokeVoidAsync("setMapStyle", style);
        }
    }

    /// <summary>
    /// Invoked by JS inside the Azure Maps 'ready' event â€” map is fully initialized.
    /// </summary>
    [JSInvokable]
    public async Task NotifyMapReady()
    {
        await OnMapReady.InvokeAsync();
    }

    /// <summary>
    /// Invoked by JS when the map viewport changes.
    /// </summary>
    [JSInvokable]
    public async Task NotifyBoundsChanged(MapBounds bounds)
    {
        await OnBoundsChanged.InvokeAsync(bounds);
    }

    public async ValueTask DisposeAsync()
    {
        if (_jsModule is not null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("dispose");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "[NebaMap] Error during dispose");
            }
            finally
            {
                await _jsModule.DisposeAsync();
            }
        }

        _dotNetHelper?.Dispose();
    }
}