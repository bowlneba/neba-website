@page "/weather"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.OutputCaching
@using Neba.Api.Contracts.Weather
@using Neba.Api.Contracts.Weather.GetWeatherForecast
@using Neba.Website.Server.Services
@attribute [StreamRendering(true)]
@attribute [OutputCache(Duration = 5)]

@inject IWeatherApi WeatherApi
@inject ApiExecutor ApiExecutor

<PageTitle>Weather</PageTitle>

<NebaErrorBoundary ShowDetails="@_isDevelopment">
    <div class="neba-space-y-6">
        <h1 class="text-2xl font-semibold">Weather</h1>

        <p class="text-neba-gray-700">This component demonstrates showing data loaded from a backend API service.</p>

        @if (_errorMessage is not null)
        {
            <NebaAlert Severity="NotifySeverity.Error"
                       Title="Failed to load weather data"
                       Message="@_errorMessage"
                       ShowIcon="true"
                       Dismissible="true"
                       OnDismiss="DismissError" />
        }

        <div class="relative min-h-[200px]">
            <NebaLoadingIndicator IsVisible="@_isLoading"
                                  Text="Loading weather data..."
                                  Scope="LoadingIndicatorScope.Section" />

            @if (_forecasts is not null)
            {
                <div class="neba-panel overflow-x-auto">
                    <table class="neba-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th aria-label="Temperature in Celsius">Temp. (C)</th>
                                <th aria-label="Temperature in Fahrenheit">Temp. (F)</th>
                                <th>Summary</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var forecast in _forecasts)
                            {
                                <tr>
                                    <td>@forecast.Date.ToShortDateString()</td>
                                    <td>@forecast.TemperatureC</td>
                                    <td>@forecast.TemperatureF</td>
                                    <td>@forecast.Summary</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</NebaErrorBoundary>

@code {
    private IReadOnlyCollection<WeatherForecastResponse>? _forecasts;
    private bool _isLoading = true;
    private string? _errorMessage;
    private bool _isDevelopment = false;

    [Inject]
    private IWebHostEnvironment Environment { get; set; } = default!;

    protected override void OnInitialized()
    {
        _isDevelopment = Environment.IsDevelopment();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadWeatherDataAsync();
    }

    private async Task LoadWeatherDataAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await ApiExecutor.ExecuteAsync(
                "Weather",
                "GetWeatherForecast",
                WeatherApi.GetWeatherForecastAsync,
                default);

            if (result.IsError)
            {
                _errorMessage = "Unable to retrieve weather forecasts. Please try again later.";
            }
            else
            {
                await Task.Delay(2500); // Simulate longer load time for demo purposes
                _forecasts = result.Value.Items;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = _isDevelopment
                ? ex.Message
                : "An unexpected error occurred while loading weather data.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void DismissError()
    {
        _errorMessage = null;
    }
}
