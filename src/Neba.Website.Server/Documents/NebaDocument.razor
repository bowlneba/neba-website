@*
    NebaDocument Component

    IMPORTANT: CSS Location
    The CSS for this component is deliberately located in wwwroot/neba-document.css rather than
    as a co-located NebaDocument.razor.css file. This is required because:

    1. The component renders dynamic HTML content from MarkupString (e.g., from Google Docs)
    2. JavaScript dynamically injects TOC lists and slide-over panel content at runtime
    3. Blazor's CSS isolation (::deep selectors) doesn't reliably style dynamically injected content
    4. The component needs global CSS selectors to properly style all dynamic content variations

    DO NOT move neba-document.css to a .razor.css file - it will break layout and functionality.
*@
@using System.Globalization
@implements IAsyncDisposable

<script src="./Documents/NebaDocument.razor.js" type="module"></script>
<link rel="stylesheet" href="/neba-document.css" />

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="mb-6">
        <NebaAlert Severity="NotifySeverity.Error"
                   Title="@ErrorTitle"
                   Message="@ErrorMessage"
                   Dismissible="true"
                   OnDismiss="@HandleErrorDismiss" />
    </div>
}

<NebaLoadingIndicator IsVisible="@IsLoading"
                      Text="@LoadingText"
                      Scope="LoadingIndicatorScope.Page" />

@if (!IsLoading && Content.HasValue)
{
    <div class="neba-document-container" id="@ContainerId">
        @if (ShowTableOfContents)
        {
            <!-- Mobile TOC Button -->
            <button class="neba-document-toc-mobile-btn" id="@TocMobileButtonId" aria-label="Open table of contents">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
                <span>Contents</span>
            </button>

            <!-- Desktop TOC -->
            <nav class="neba-document-toc" id="@TocId" aria-label="Table of Contents">
                <div class="toc-sticky">
                    <h2 class="toc-title">@TableOfContentsTitle</h2>
                    <div id="@TocListId"></div>
                </div>
            </nav>

            <!-- Mobile TOC Modal -->
            <div class="neba-document-toc-modal" id="@TocModalId" role="dialog" aria-modal="true" aria-labelledby="@TocModalTitleId">
                <div class="neba-document-toc-modal-overlay" id="@TocModalOverlayId"></div>
                <div class="neba-document-toc-modal-content">
                    <div class="neba-document-toc-modal-header">
                        <h2 id="@TocModalTitleId" class="toc-title">@TableOfContentsTitle</h2>
                        <button class="neba-document-toc-modal-close" id="@TocModalCloseId" aria-label="Close table of contents">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="neba-document-toc-modal-body">
                        <div id="@TocMobileListId"></div>
                    </div>
                </div>
            </div>
        }

        <div class="neba-panel neba-document-content" id="@ContentId">
            @Content
        </div>

        <!-- Last Updated Footer -->
        @{
            var lastUpdatedText = GetLastUpdatedText();
        }
        @if (!string.IsNullOrWhiteSpace(lastUpdatedText))
        {
            <div class="neba-document-last-updated-bottom">
                @lastUpdatedText
            </div>
        }

        <!-- Slide-over Panel for Internal Links -->
        <div class="neba-document-slideover" id="@SlideoverId" role="dialog" aria-modal="true" aria-labelledby="@SlideoverTitleId">
            <div class="neba-document-slideover-overlay" id="@SlideoverOverlayId"></div>
            <div class="neba-document-slideover-panel">
                <div class="neba-document-slideover-header">
                    <h2 id="@SlideoverTitleId" class="neba-document-slideover-title">@(SlideoverTitle ?? "Loading...")</h2>
                    <button class="neba-document-slideover-close" id="@SlideoverCloseId" aria-label="Close document">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                        </svg>
                    </button>
                </div>
                <div class="neba-document-slideover-content" id="@SlideoverContentId">
                    @if (SlideoverIsLoading)
                    {
                        <div style="padding: 2rem; text-align: center; color: var(--neba-gray-600);">Loading document...</div>
                    }
                    else if (SlideoverContent.HasValue)
                    {
                        @SlideoverContent
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter][EditorRequired]
    public MarkupString? Content { get; set; }

    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public string LoadingText { get; set; } = "Loading document...";

    [Parameter]
    public string? ErrorMessage { get; set; }

    [Parameter]
    public string ErrorTitle { get; set; } = "Error Loading Document";

    [Parameter]
    public EventCallback OnErrorDismiss { get; set; }

    [Parameter]
    public bool ShowTableOfContents { get; set; } = true;

    [Parameter]
    public string TableOfContentsTitle { get; set; } = "Contents";

    [Parameter]
    public string HeadingLevels { get; set; } = "h1, h2";

    [Parameter]
    public string? DocumentId { get; set; }

    [Parameter]
    public IReadOnlyDictionary<string, string>? Metadata { get; set; }

    /// <summary>
    /// Callback invoked when an internal document link is clicked in the content.
    /// The string parameter is the pathname of the linked document (e.g., "bylaws").
    /// The parent page should fetch the document and set <see cref="SlideoverContent"/> and <see cref="SlideoverTitle"/>.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnSlideoverLinkClicked { get; set; }

    /// <summary>
    /// Content to display in the slideover panel, set by the parent page after fetching.
    /// </summary>
    [Parameter]
    public MarkupString? SlideoverContent { get; set; }

    /// <summary>
    /// Title to display in the slideover panel header.
    /// </summary>
    [Parameter]
    public string? SlideoverTitle { get; set; }

    /// <summary>
    /// Controls the loading state of the slideover panel.
    /// </summary>
    [Parameter]
    public bool SlideoverIsLoading { get; set; }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    [Inject]
    private ILogger<NebaDocument> Logger { get; set; } = default!;

    private IJSObjectReference? _module;
    private DotNetObjectReference<NebaDocument>? _dotNetRef;
    private bool _tocInitialized;
    private MarkupString? _previousContent;
    private MarkupString? _previousSlideoverContent;
    private string _instanceId = Guid.NewGuid().ToString("N")[..8];

    private string ContainerId => $"neba-document-{_instanceId}";
    private string ContentId => $"neba-document-content-{_instanceId}";
    private string TocId => $"neba-document-toc-{_instanceId}";
    private string TocListId => $"neba-document-toc-list-{_instanceId}";
    private string TocMobileButtonId => $"neba-document-toc-mobile-btn-{_instanceId}";
    private string TocModalId => $"neba-document-toc-modal-{_instanceId}";
    private string TocModalOverlayId => $"neba-document-toc-modal-overlay-{_instanceId}";
    private string TocModalCloseId => $"neba-document-toc-modal-close-{_instanceId}";
    private string TocModalTitleId => $"neba-document-toc-modal-title-{_instanceId}";
    private string TocMobileListId => $"neba-document-toc-mobile-list-{_instanceId}";
    private string SlideoverId => $"neba-document-slideover-{_instanceId}";
    private string SlideoverOverlayId => $"neba-document-slideover-overlay-{_instanceId}";
    private string SlideoverCloseId => $"neba-document-slideover-close-{_instanceId}";
    private string SlideoverTitleId => $"neba-document-slideover-title-{_instanceId}";
    private string SlideoverContentId => $"neba-document-slideover-content-{_instanceId}";

    protected override void OnInitialized()
    {
        if (!string.IsNullOrWhiteSpace(DocumentId))
        {
            _instanceId = DocumentId;
        }
    }

    protected override void OnParametersSet()
    {
        if (Content.HasValue && !Content.Equals(_previousContent))
        {
            _tocInitialized = false;
            _previousContent = Content;
        }

        // Track slideover content changes to trigger re-initialization of link handlers
        if (SlideoverContent.HasValue && !SlideoverContent.Equals(_previousSlideoverContent))
        {
            _previousSlideoverContent = SlideoverContent;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Initialize TOC and main content link handlers
        if (!_tocInitialized && Content.HasValue)
        {
            try
            {
                _module ??= await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./Documents/NebaDocument.razor.js");

                _dotNetRef ??= DotNetObjectReference.Create(this);

                var success = await _module.InvokeAsync<bool>("initialize", _dotNetRef, new
                {
                    contentId = ContentId,
                    tocListId = TocListId,
                    tocMobileListId = TocMobileListId,
                    tocMobileButtonId = TocMobileButtonId,
                    tocModalId = TocModalId,
                    tocModalOverlayId = TocModalOverlayId,
                    tocModalCloseId = TocModalCloseId,
                    headingLevels = HeadingLevels,
                    slideoverId = SlideoverId,
                    slideoverOverlayId = SlideoverOverlayId,
                    slideoverCloseId = SlideoverCloseId
                });

                if (success)
                {
                    _tocInitialized = true;
                    await _module.InvokeVoidAsync("scrollToHash", ContentId, TocListId);
                }
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected - browser will clean up JS resources
            }
            catch (TaskCanceledException)
            {
                // Disposal in progress
            }
            catch (Exception ex)
            {
                Logger.LogTocInitializationFailed(ex, ContentId);
            }
        }

        // Initialize slideover content link handlers after content loads
        if (_module is not null && SlideoverContent.HasValue && !SlideoverIsLoading)
        {
            try
            {
                await _module.InvokeVoidAsync("initializeSlideoverContent", SlideoverContentId);
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected - browser will clean up JS resources
            }
            catch (TaskCanceledException)
            {
                // Disposal in progress
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to initialize slideover content link handlers for {ContentId}", SlideoverContentId);
            }
        }
    }

    [JSInvokable]
    public async Task OnInternalLinkClicked(string pathname)
    {
        if (OnSlideoverLinkClicked.HasDelegate)
        {
            await OnSlideoverLinkClicked.InvokeAsync(pathname);
        }
    }

    private async Task HandleErrorDismiss()
    {
        ErrorMessage = null;
        if (OnErrorDismiss.HasDelegate)
        {
            await OnErrorDismiss.InvokeAsync();
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("dispose");
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected - browser will clean up JS resources
            }
            catch (TaskCanceledException)
            {
                // Disposal was cancelled
            }
        }

        _dotNetRef?.Dispose();
    }

    private string? GetLastUpdatedText()
    {
        if (Metadata is null || !Metadata.TryGetValue("LastUpdatedUtc", out var lastUpdatedUtcStr))
        {
            return null;
        }

        if (!DateTime.TryParse(lastUpdatedUtcStr, CultureInfo.InvariantCulture, out var lastUpdatedUtc))
        {
            return null;
        }

        if (Metadata.TryGetValue("LastUpdatedBy", out var lastUpdatedBy))
        {
            return $"{lastUpdatedUtc:yyyy-MM-dd} by {lastUpdatedBy}";
        }

        return lastUpdatedUtc.ToString("yyyy-MM-dd");
    }
}
