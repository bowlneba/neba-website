@page "/bylaws"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Neba.Api.Contracts.Documents
@using Neba.Website.Server.Documents
@using Neba.Website.Server.Services

@inject ApiExecutor ApiExecutor
@inject IDocumentsApi DocumentsApi

<PageTitle>Bylaws - NEBA</PageTitle>

<!-- Page Header -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">NEBA Bylaws</h1>
    <p class="mt-1 text-sm text-gray-600">Official bylaws and organizational guidelines</p>
</div>

<NebaDocument Content="@_content"
              IsLoading="@_isLoading"
              ErrorMessage="@_errorMessage"
              LoadingText="Loading bylaws..."
              ErrorTitle="Error Loading Bylaws"
              ShowTableOfContents="true"
              TableOfContentsTitle="Contents"
              HeadingLevels="h1, h2"
              DocumentId="bylaws"
              OnSlideoverLinkClicked="@HandleSlideoverLinkClicked"
              SlideoverContent="@_slideoverContent"
              SlideoverTitle="@_slideoverTitle"
              SlideoverIsLoading="@_slideoverIsLoading" />

@code {
    private MarkupString? _content;
    private string? _errorMessage;
    private bool _isLoading = true;

    private MarkupString? _slideoverContent;
    private string? _slideoverTitle;
    private bool _slideoverIsLoading;

    protected override async Task OnInitializedAsync()
    {
        var result = await ApiExecutor.ExecuteAsync(
            "Documents",
            "GetBylaws",
            ct => DocumentsApi.GetDocumentAsync("bylaws", ct));

        if (result.IsError)
        {
            _errorMessage = $"Failed to load bylaws: {result.FirstError.Description}";
        }
        else
        {
            _content = new MarkupString(result.Value.Html);
        }

        _isLoading = false;
    }

    private async Task HandleSlideoverLinkClicked(string pathname)
    {
        _slideoverIsLoading = true;
        StateHasChanged();

        // Map web route to document name
        var route = pathname.TrimStart('/');
        var documentName = GetDocumentNameFromRoute(route);

        if (documentName is null)
        {
            _slideoverContent = new MarkupString($"<p>Document not found for route: {pathname}</p>");
            _slideoverIsLoading = false;
            StateHasChanged();
            return;
        }

        _slideoverTitle = GetDocumentTitle(documentName);

        var result = await ApiExecutor.ExecuteAsync(
            "Documents",
            $"Get{documentName}",
            ct => DocumentsApi.GetDocumentAsync(documentName, ct));

        _slideoverIsLoading = false;

        if (result.IsError)
        {
            _slideoverContent = new MarkupString($"<p>Failed to load document: {result.FirstError.Description}</p>");
        }
        else
        {
            _slideoverContent = new MarkupString(result.Value.Html);
        }

        StateHasChanged();
    }

    private static string? GetDocumentNameFromRoute(string route)
    {
        // Map WebRoute to document Name
        // This mapping corresponds to Google.Documents configuration in appsettings.json
        return route switch
        {
            "about/bylaws" => "bylaws",
            "tournaments/rules" => "tournament-rules",
            _ => null
        };
    }

    private static string GetDocumentTitle(string documentName)
    {
        // Convert document name to display title
        return documentName switch
        {
            "bylaws" => "Bylaws",
            "tournament-rules" => "Tournament Rules",
            _ => string.Join(' ', documentName.Split('-')
                .Select(word => char.ToUpperInvariant(word[0]) + word[1..]))
        };
    }
}
